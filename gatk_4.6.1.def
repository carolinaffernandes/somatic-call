Bootstrap: docker
From: broadinstitute/gatk:4.6.1.0

%post
    # 1. Limpeza inicial
    rm -rf /tmp/build
    mkdir -p /tmp/build

    # 2. Dependências do sistema (para compilar BWA/Samtools)
    apt-get update && apt-get install -y \
        build-essential \
        wget \
        libncurses5-dev \
        libcurl4-gnutls-dev \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        liblzma-dev

    # Variáveis
    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++
    export BWA_VER=0.7.17
    export HTS_VER=1.21
    export BWA_FLAGS="-g -Wall -Wno-unused-function -O2 -DHAVE_PTHREAD -DUSE_MALLOC_WRAPPERS -fcommon"

    # =========================================================================
    # PARTE 1: INSTALAÇÃO VIA CONDA (QC e Utils)
    # =========================================================================
    echo "Instalando ferramentas via Conda..."
    
    # Removemos vcftools e bedtools.
    # Mantemos apenas o essencial para QC e automação.
    conda install -c bioconda -c conda-forge -y \
        fastp=0.23.4 \
        multiqc=1.25.1 \
        parallel=20230722 \
        pyyaml=6.0

    conda clean -afy

    # =========================================================================
    # PARTE 2: COMPILAÇÃO MANUAL (Core Tools: BWA, Samtools, Bcftools)
    # =========================================================================
    cd /tmp/build

    # --- BWA v0.7.17 ---
    echo "Instalando BWA ${BWA_VER}..."
    wget https://github.com/lh3/bwa/releases/download/v${BWA_VER}/bwa-${BWA_VER}.tar.bz2
    tar -xjf bwa-${BWA_VER}.tar.bz2
    cd bwa-${BWA_VER}
    make clean
    make CC=$CC CFLAGS="${BWA_FLAGS}"
    cp bwa /usr/local/bin/
    cd /tmp/build

    # --- HTSlib / Samtools / Bcftools v1.21 ---
    # HTSlib (Dependência)
    echo "Instalando HTSlib ${HTS_VER}..."
    wget https://github.com/samtools/htslib/releases/download/${HTS_VER}/htslib-${HTS_VER}.tar.bz2
    tar -xjf htslib-${HTS_VER}.tar.bz2
    cd htslib-${HTS_VER}
    ./configure --prefix=/usr/local CC=$CC
    make -j4
    make install
    cd /tmp/build

    # Samtools
    echo "Instalando Samtools ${HTS_VER}..."
    wget https://github.com/samtools/samtools/releases/download/${HTS_VER}/samtools-${HTS_VER}.tar.bz2
    tar -xjf samtools-${HTS_VER}.tar.bz2
    cd samtools-${HTS_VER}
    ./configure --prefix=/usr/local --with-htslib=system CC=$CC
    make -j4
    make install
    cd /tmp/build

    # Bcftools (O substituto moderno do vcftools)
    echo "Instalando Bcftools ${HTS_VER}..."
    wget https://github.com/samtools/bcftools/releases/download/${HTS_VER}/bcftools-${HTS_VER}.tar.bz2
    tar -xjf bcftools-${HTS_VER}.tar.bz2
    cd bcftools-${HTS_VER}
    ./configure --prefix=/usr/local --with-htslib=system CC=$CC
    make -j4
    make install
    
    # =========================================================================
    # LIMPEZA FINAL
    # =========================================================================
    cd /
    rm -rf /tmp/build
    apt-get remove -y build-essential
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=C
    export PATH=/usr/local/bin:$PATH

%labels
    Author Maria Carolina F. C. Santos
    Description Pipeline Somático Híbrido (GATK, BWA, Fastp)
    Tools GATK 4.6, BWA 0.7.17, Samtools 1.21, Bcftools 1.21, Fastp 0.23, MultiQC 1.25.1
